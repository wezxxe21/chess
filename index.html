<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chess vs Stockfish</title>
<style>
body {
    background:#111;
    color:white;
    font-family:Arial;
    text-align:center;
}
#board {
    display:grid;
    grid-template-columns:repeat(8,60px);
    width:480px;
    margin:20px auto;
}
.square {
    width:60px;
    height:60px;
    font-size:40px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
}
.white { background:#eee; color:black; }
.black { background:#666; }
</style>
</head>
<body>

<h1>♟ Chess vs Stockfish</h1>
<div id="board"></div>
<div id="status">Your move</div>

<script>
/* ---------------- PIECES ---------------- */
const P = {
 r:"♜",n:"♞",b:"♝",q:"♛",k:"♚",p:"♟",
 R:"♖",N:"♘",B:"♗",Q:"♕",K:"♔",P:"♙"
};

let board=[
"rnbqkbnr",
"pppppppp",
"........",
"........",
"........",
"........",
"PPPPPPPP",
"RNBQKBNR"
];

let selected=null;
let history=[];

/* ---------------- SAFE STOCKFISH WORKER ---------------- */
const workerCode = `
self.importScripts("https://cdn.jsdelivr.net/npm/stockfish@16.1/stockfish.js");
self.onmessage = e => postMessage(e.data);
`;

const engine = new Worker(
    URL.createObjectURL(new Blob([workerCode],{type:"application/javascript"}))
);

engine.postMessage("uci");
engine.postMessage("isready");

engine.onmessage = e => {
    if(e.data.startsWith("bestmove")){
        move(e.data.split(" ")[1]);
        draw();
        status("Your move");
    }
};

/* ---------------- BOARD ---------------- */
const boardDiv=document.getElementById("board");
const statusDiv=document.getElementById("status");

function status(t){ statusDiv.textContent=t; }

function draw(){
    boardDiv.innerHTML="";
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
        const d=document.createElement("div");
        d.className="square "+((r+c)%2?"black":"white");
        const p=board[r][c];
        if(p!=".") d.textContent=P[p];
        d.onclick=()=>click(r,c);
        boardDiv.appendChild(d);
    }
}

function click(r,c){
    if(!selected){
        if(board[r][c]===".") return;
        selected={r,c};
    } else {
        const m=toUCI(selected,r,c);
        selected=null;
        move(m);
        draw();
        status("Stockfish thinking...");
        engine.postMessage("position startpos moves "+history.join(" "));
        engine.postMessage("go depth 12");
    }
}

function toUCI(a,r,c){
    return "abcdefgh"[a.c]+(8-a.r)+
           "abcdefgh"[c]+(8-r);
}

/* ---------------- MOVE ---------------- */
function move(m){
    const fr=8-m[1], fc="abcdefgh".indexOf(m[0]);
    const tr=8-m[3], tc="abcdefgh".indexOf(m[2]);
    const piece=board[fr][fc];
    board[fr]=set(board[fr],fc,".");
    board[tr]=set(board[tr],tc,piece);
    history.push(m);
}

function set(s,i,c){
    return s.slice(0,i)+c+s.slice(i+1);
}

draw();
</script>
</body>
</html>
