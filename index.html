<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chess vs Stockfish</title>
<style>
body {
    background:#0b0b0b;
    color:white;
    font-family:Arial;
    text-align:center;
}
#board {
    display:grid;
    grid-template-columns:repeat(8,64px);
    width:512px;
    margin:20px auto;
    border:3px solid #444;
}
.square {
    width:64px;
    height:64px;
    display:flex;
    align-items:center;
    justify-content:center;
}
.white { background:#f0d9b5; }
.black { background:#b58863; }
.square img {
    width:52px;
    height:52px;
    cursor:pointer;
}
</style>
</head>
<body>

<h1>â™Ÿ Chess vs Stockfish</h1>
<div id="board"></div>
<div id="status">Loading engine...</div>

<script>
/* ---------------- PIECES (chess.com CDN) ---------------- */
const PIECES = {
 r:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/br.png",
 n:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bn.png",
 b:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bb.png",
 q:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bq.png",
 k:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bk.png",
 p:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bp.png",
 R:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wr.png",
 N:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wn.png",
 B:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wb.png",
 Q:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wq.png",
 K:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wk.png",
 P:"https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wp.png"
};

/* ---------------- GAME STATE ---------------- */
let board=[
"rnbqkbnr",
"pppppppp",
"........",
"........",
"........",
"........",
"PPPPPPPP",
"RNBQKBNR"
];
let selected=null;
let moves=[];

/* ---------------- LOAD STOCKFISH SAFELY ---------------- */
async function loadEngine(){
    const res = await fetch(
      "https://cdn.jsdelivr.net/npm/stockfish@16.1/stockfish.js"
    );
    const code = await res.text();

    const blob = new Blob([code], {type:"application/javascript"});
    const engine = new Worker(URL.createObjectURL(blob));

    engine.postMessage("uci");
    engine.postMessage("isready");

    engine.onmessage = e => {
        if(e.data.startsWith("bestmove")){
            applyMove(e.data.split(" ")[1]);
            draw();
            status("Your move");
        }
    };
    return engine;
}

const enginePromise = loadEngine();
const boardDiv=document.getElementById("board");
const statusDiv=document.getElementById("status");
function status(t){ statusDiv.textContent=t; }

/* ---------------- DRAW BOARD ---------------- */
function draw(){
    boardDiv.innerHTML="";
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
        const sq=document.createElement("div");
        sq.className="square "+((r+c)%2?"black":"white");
        const p=board[r][c];
        if(p!="."){
            const img=document.createElement("img");
            img.src=PIECES[p];
            sq.appendChild(img);
        }
        sq.onclick=()=>click(r,c);
        boardDiv.appendChild(sq);
    }
}

async function click(r,c){
    if(!selected){
        if(board[r][c]===".") return;
        selected={r,c};
    } else {
        const m=uci(selected,r,c);
        selected=null;
        applyMove(m);
        draw();
        status("Stockfish thinking...");
        const engine=await enginePromise;
        engine.postMessage("position startpos moves "+moves.join(" "));
        engine.postMessage("go depth 12");
    }
}

function uci(a,r,c){
    return "abcdefgh"[a.c]+(8-a.r)+
           "abcdefgh"[c]+(8-r);
}

/* ---------------- MOVE APPLY ---------------- */
function applyMove(m){
    const fr=8-m[1], fc="abcdefgh".indexOf(m[0]);
    const tr=8-m[3], tc="abcdefgh".indexOf(m[2]);
    const p=board[fr][fc];
    board[fr]=set(board[fr],fc,".");
    board[tr]=set(board[tr],tc,p);
    moves.push(m);
}

function set(s,i,c){
    return s.slice(0,i)+c+s.slice(i+1);
}

draw();
status("Your move");
</script>

</body>
</html>
